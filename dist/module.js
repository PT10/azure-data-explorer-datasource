define(["lodash","app/core/config","@grafana/data","app/plugins/sdk","angular"],(function(t,e,r,n,o){return function(t){function e(e){for(var r,o,a=e[0],i=e[1],s=0,l=[];s<a.length;s++)o=a[s],n[o]&&l.push(n[o][0]),n[o]=0;for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r]);for(u&&u(e);l.length;)l.shift()()}var r={},n={1:0};function o(e){if(r[e])return r[e].exports;var n=r[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.e=function(t){var e=[],r=n[t];if(0!==r)if(r)e.push(r[2]);else{var a=new Promise((function(e,o){r=n[t]=[e,o]}));e.push(r[2]=a);var i,s=document.createElement("script");s.charset="utf-8",s.timeout=120,o.nc&&s.setAttribute("nonce",o.nc),s.src=function(t){return o.p+""+({0:"/monaco.min"}[t]||t)+".js"}(t);var u=new Error;i=function(e){s.onerror=s.onload=null,clearTimeout(l);var r=n[t];if(0!==r){if(r){var o=e&&("load"===e.type?"missing":e.type),a=e&&e.target&&e.target.src;u.message="Loading chunk "+t+" failed.\n("+o+": "+a+")",u.name="ChunkLoadError",u.type=o,u.request=a,r[1](u)}n[t]=void 0}};var l=setTimeout((function(){i({type:"timeout",target:s})}),12e4);s.onerror=s.onload=i,document.head.appendChild(s)}return Promise.all(e)},o.m=t,o.c=r,o.d=function(t,e,r){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(r,n,function(e){return t[e]}.bind(null,n));return r},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/public/plugins/grafana-azure-data-explorer-datasource/",o.oe=function(t){throw console.error(t),t};var a=window.webpackJsonp=window.webpackJsonp||[],i=a.push.bind(a);a.push=e,a=a.slice();for(var s=0;s<a.length;s++)e(a[s]);var u=i;return o(o.s=5)}([function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e){t.exports=o},function(t,e,r){"use strict";r.r(e);var n=r(0),o=r.n(n),a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function i(t,e,r,n){return new(r||(r=Promise))((function(o,a){function i(t){try{u(n.next(t))}catch(t){a(t)}}function s(t){try{u(n.throw(t))}catch(t){a(t)}}function u(t){t.done?o(t.value):new r((function(e){e(t.value)})).then(i,s)}u((n=n.apply(t,e||[])).next())}))}function s(t,e){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(t,i)}catch(t){a=[6,t],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function u(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}var l=r(2),c=function(){function t(){}return t.prototype.parseAnnotations=function(e,r){var n=[];return e.data.hasOwnProperty("results")?Object.keys(e.data.results).forEach((function(o){var a=e.data.results[o];a.tables.length>0&&a.tables.forEach((function(e){e.rows.forEach((function(o){var a={annotation:r.annotation,time:0,text:"",tags:[]};e.columns.forEach((function(e,r){switch(e.text){case"StartTime":a.time=Math.floor(t.dateTimeToEpoch(o[r]));break;case"Text":a.text=o[r];break;case"Tags":a.tags=o[r].trim().split(/\s*,\s*/)}})),n.push(a)}))}))})):n=this.transformToAnnotations(r,e),n},t.prototype.parseDatabases=function(t){var e,r,n,o,a=[];if(!t||!t.data||!t.data.Tables||0===t.data.Tables.length)return a;try{for(var i=u(t.data.Tables),s=i.next();!s.done;s=i.next()){var l=s.value;try{for(var c=(n=void 0,u(l.Rows)),d=c.next();!d.done;d=c.next()){var f=d.value;a.push({text:f[5]||f[0],value:f[0]})}}catch(t){n={error:t}}finally{try{d&&!d.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}}}catch(t){e={error:t}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return a},t.prototype.parseSchemaResult=function(t){var e=t.Tables[0].Rows[0][0];return JSON.parse(e)},t.prototype.hasPropertyOfArray=function(t,e){return void 0!==t&&t.hasOwnProperty(e)&&Array.isArray(t[e])},t.prototype.parseQueryResult=function(t){var e;return this.hasPropertyOfArray(t.data,"Series")&&(e=this.parseTimeSeriesResult(t,t.data.Series[0].Columns,t.data.Series[0].Rows)),this.hasPropertyOfArray(t.data,"Tables")&&(e=this.parseTableResult(t,t.data.Tables[0].Columns,t.data.Tables[0].Rows)),{data:[e]}},t.prototype.parseTimeSeriesResult=function(e,r,n){for(var o,a,i=[],s=-1,l=-1,c=-1,d=0;d<r.length;d++)-1===s&&"datetime"===r[d].ColumnType&&(s=d),-1===l&&"string"===r[d].ColumnType&&(l=d),-1===c&&["int","long","real","double"].includes(r[d].ColumnType)&&(c=d);if(-1===s)throw new Error("No datetime column found in the result. The Time Series format requires a time column.");try{for(var f=u(n),h=f.next();!h.done;h=f.next()){var p=h.value,m=t.dateTimeToEpoch(p[s]),g=l>-1?p[l]:r[c].name,y=t.findOrCreateBucket(i,g);y.datapoints.push([p[c],m]),y.refId=e.refId,y.query=e.query}}catch(t){o={error:t}}finally{try{h&&!h.done&&(a=f.return)&&a.call(f)}finally{if(o)throw o.error}}return i},t.prototype.parseTableResult=function(t,e,r){return{type:"table",columns:o.a.map(e,(function(t){return{text:t.ColumnName,type:t.ColumnType}})),rows:r,refId:t.refId,query:t.query}},t.prototype.parseToVariables=function(t){var e,r,n=[],o=this.parseQueryResult(t);try{for(var a=u(o.data),i=a.next();!i.done;i=a.next()){var s=i.value,l=this.findColIndex(s,"__text"),c=this.findColIndex(s,"__value");n=-1!==l&&-1!==c?n.concat(this.transformToKeyValueList(s.rows,l,c)):n.concat(this.transformToSimpleList(s.rows))}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}return n},t.prototype.transformToKeyValueList=function(t,e,r){for(var n=[],o=0;o<t.length;o++)this.containsKey(n,t[o][e])||n.push({text:t[o][e],value:t[o][r]});return n},t.prototype.transformToSimpleList=function(t){var e,r,n=[];try{for(var a=u(o.a.flattenDeep(t)),i=a.next();!i.done;i=a.next()){var s=i.value;n.push({text:s,value:s})}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}return n},t.prototype.findColIndex=function(t,e){if("columns"in t)for(var r=t.columns,n=0;n<r.length;n++)if(r[n].text===e)return n;return-1},t.prototype.containsKey=function(t,e){for(var r=0;r<t.length;r++)if(t[r].text===e)return!0;return!1},t.prototype.transformToAnnotations=function(e,r){var n,o,a,i,s=this.parseQueryResult(r),l=[];try{for(var c=u(s.data),d=c.next();!d.done;d=c.next()){for(var f=d.value,h=-1,p=-1,m=-1,g=0;g<f.columns.length;g++)-1===h&&"datetime"===f.columns[g].type&&(h=g),-1===p&&"text"===f.columns[g].text.toLowerCase()&&(p=g),-1===m&&"tags"===f.columns[g].text.toLowerCase()&&(m=g);try{for(var y=(a=void 0,u(f.rows)),v=y.next();!v.done;v=y.next()){var b=v.value;l.push({annotation:e.annotation,time:Math.floor(t.dateTimeToEpoch(b[h])),text:b[p]?b[p].toString():"",tags:b[m]?b[m].trim().split(/\s*,\s*/):[]})}}catch(t){a={error:t}}finally{try{v&&!v.done&&(i=y.return)&&i.call(y)}finally{if(a)throw a.error}}}}catch(t){n={error:t}}finally{try{d&&!d.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}return l},t.findOrCreateBucket=function(t,e){var r=o.a.find(t,["target",e]);return r||(r={target:e,datapoints:[],refId:"",query:""},t.push(r)),r},t.dateTimeToEpoch=function(t){return Object(l.dateTime)(t).valueOf()},t.prototype.processQueryResult=function(t){var e,r,n,o,a=[];if(!t.data.results)return{data:a};var i={};for(var s in t.data.results){var l=t.data.results[s];if(l.series)try{for(var c=(e=void 0,u(l.series)),d=c.next();!d.done;d=c.next()){var f=d.value,h=f.name;try{h=JSON.parse(f.name)}catch(t){h={value:{metricname:f.name}}}i[Object.keys(h)[0]]=0,a.push({target:h,datapoints:f.points,refId:l.refId,meta:l.meta})}}catch(t){e={error:t}}finally{try{d&&!d.done&&(r=c.return)&&r.call(c)}finally{if(e)throw e.error}}if(l.tables)try{for(var p=(n=void 0,u(l.tables)),m=p.next();!m.done;m=p.next()){var g=m.value;g.type="table",g.refId=l.refId,g.meta=l.meta,a.push(g)}}catch(t){n={error:t}}finally{try{m&&!m.done&&(o=p.return)&&o.call(p)}finally{if(n)throw n.error}}}return{data:a,valueCount:Object.keys(i).length}},t}(),d=function(){function t(t,e){this.rawQuery=t,this.options=e}return t.prototype.interpolate=function(){var t=this;if(!this.rawQuery)return{query:""};var e=this.rawQuery;return e=(e=e.replace(/\$__([_a-zA-Z0-9]+)\(([^\)]*)\)/gi,(function(e,r,n){return"contains"===r?t.getMultiContains(n):e}))).replace(/\$__escapeMulti\(('[^]*')\)/gi,(function(e,r){return t.escape(r)})),this.options,{query:e}},t.prototype.getFrom=function(t){return"datetime("+t.range.from.toISOString()},t.prototype.getUntil=function(t){return"now"===t.rangeRaw.to?"now()":"datetime("+t.range.to.toISOString()+")"},t.prototype.getTimeFilter=function(t,e){return"now"===e.rangeRaw.to?t+" >= "+this.getFrom(e):t+"  >= "+this.getFrom(e)+" and "+t+" <= "+this.getUntil(e)},t.prototype.getMultiContains=function(t){var e=t.indexOf(","),r=t.substring(0,e),n=t.substring(t.indexOf(",")+1);return n&&"all"===n.toLowerCase().trim()?"1 == 1":r.trim()+" in ("+n.trim()+")"},t.prototype.escape=function(t){return t.substring(1,t.length-1).split("','").map((function(t){return"@'"+t+"'"})).join(", ")},t}(),f=function(){function t(t){void 0===t&&(t={ttl:1e4}),this.opts=t,this.store={}}return t.prototype.put=function(t,e,r){var n=this;void 0===r&&(r=this.opts.ttl),void 0!==t&&void 0!==e&&(this.del(t),this.store[t]={value:e,expire:Date.now()+r,timeout:setTimeout((function(){n.del(t)}),r)})},t.prototype.get=function(t){var e=this.store[t];return e&&e.expire&&e.expire<=Date.now()&&(this.del(t),e=void 0),e&&e.value},t.prototype.del=function(t){this.store.hasOwnProperty(t)&&(clearTimeout(this.store[t].timeout),delete this.store[t])},t}(),h=function(){function t(t){this.backendSrv=t,this.ongoingRequests={}}return t.prototype.doRequest=function(t,e,r){return void 0===r&&(r=1),i(this,void 0,void 0,(function(){var n=this;return s(this,(function(o){return[2,this.backendSrv.datasourceRequest({url:t,method:"POST",data:e}).catch((function(o){if(r>0)return n.doRequest(t,e,r-1);throw o}))]}))}))},t.prototype.dsPost=function(t,e,r){return i(this,void 0,void 0,(function(){var n=this;return s(this,(function(o){return this.ongoingRequests.hasOwnProperty(t)?[2,this.ongoingRequests[t]]:(this.ongoingRequests[t]=new Promise((function(o,a){return i(n,void 0,void 0,(function(){var n,i;return s(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,3,4]),[4,this.doRequest(e,r)];case 1:return n=s.sent(),o(n),[3,4];case 2:return i=s.sent(),a(i),[3,4];case 3:return delete this.ongoingRequests[t],[7];case 4:return[2]}}))}))})),[2,this.ongoingRequests[t]])}))}))},t}(),p=function(){function t(t,e,r,n){this.backendSrv=e,this.$q=r,this.templateSrv=n,this.name=t.name,this.id=t.id,this.baseUrl="/azuredataexplorer",this.url=t.url,this.defaultOrFirstDatabase=t.jsonData.defaultDatabase,this.cache=new f({ttl:this.getCacheTtl(t)}),this.requestAggregatorSrv=new h(e)}return t.$inject=["instanceSettings","backendSrv","$q","templateSrv"],t.prototype.query=function(t){var e=this,r={},n=o.a.filter(t.targets,(function(t){return r[t.refId]=t,!0!==t.hide})).map((function(r){var n=new d(e.templateSrv.replace(r.query,t.scopedVars,e.interpolateVariable),t).interpolate().query;return{refId:r.refId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,datasourceId:e.id,query:n,database:r.database,resultFormat:r.resultFormat}}));return 0===n.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:n}}).then((function(t){var n=(new c).processQueryResult(t);return n.data.forEach((function(t){var o={},a=r[t.refId];if("time_series"===a.resultFormat){var i=a.alias;try{var s=Object.keys(t.target)[0],u=t.target;"0"!==s&&(u=t.target[s]);var l=JSON.stringify(t.target).replace(/"/g,"").replace(/^\{(.*?)\}$/,"$1"),c=u[Object.keys(u)[0]];void 0!==n.valueCount&&n.valueCount>1&&(c=Object.keys(u).map((function(t){return"$"+t})).join(".")+".$value"),o.value={text:s,value:s},o.full={text:l,value:l},Object.keys(u).forEach((function(t){o[t]={text:u[t],value:u[t]}})),i||(i=c),t.target=e.templateSrv.replace(i,o)}catch(t){console.log("Error generating time series alias",t)}}})),n}))},t.prototype.annotationQuery=function(t){if(!t.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var e=this.buildQuery(t.annotation.rawQuery,t,t.annotation.database);return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:e}}).then((function(e){return(new c).parseAnnotations(e,t)}))},t.prototype.metricFindQuery=function(t,e){var r=this;return this.getDefaultOrFirstDatabase().then((function(n){return r.buildQuery(t,e,n)})).then((function(t){return r.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",queries:t})})).then((function(t){return(new c).parseToVariables(t)})).catch((function(t){throw console.log("There was an error",t),t}))},t.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:"5m",to:"now",queries:[{refId:"A",intervalMs:1,maxDataPoints:1,datasourceId:this.id,query:".show databases",resultFormat:"test"}]}}).then((function(t){return{status:"success",message:"Connection Successful"}})).catch((function(t){return t.data&&t.data.message?{status:"error",message:t.data.message}:{status:"error",message:t.status}}))},t.prototype.getDatabases=function(){var t=this.baseUrl+"/v1/rest/mgmt";return this.doRequest(t,{csl:".show databases"}).then((function(t){return(new c).parseDatabases(t)}))},t.prototype.getDefaultOrFirstDatabase=function(){var t=this;return this.defaultOrFirstDatabase?Promise.resolve(this.defaultOrFirstDatabase):this.getDatabases().then((function(e){return t.defaultOrFirstDatabase=e[0].value,t.defaultOrFirstDatabase}))},t.prototype.getSchema=function(t){var e=this.baseUrl+"/v1/rest/mgmt",r={csl:".show database ["+t+"] schema as json"};return this.doRequest(e,r).then((function(t){return(new c).parseSchemaResult(t.data)}))},t.prototype.doQueries=function(t){var e=this;return t.map((function(t){var r=e.cache.get(t.key);return r||e.requestAggregatorSrv.dsPost(t.key,e.url+t.url,t.data).then((function(r){var n={result:r,query:t};return t.key&&e.cache.put(t.key,n),n})).catch((function(e){throw{error:e,query:t}}))}))},t.prototype.buildQuery=function(t,e,r){void 0===e&&(e={}),void 0===e.scopedVars&&(e.scopedVars={});var n=new d(this.templateSrv.replace(t,e.scopedVars,this.interpolateVariable),e),o=this.baseUrl+"/v1/rest/query",a=n.interpolate().query,i=[];return i.push({key:o+"-table-"+r+"-"+a,datasourceId:this.id,url:o,resultFormat:"table",query:a,database:r}),i},t.prototype.doRequest=function(t,e,r){var n=this;return void 0===r&&(r=1),this.backendSrv.datasourceRequest({url:this.url+t,method:"POST",data:e}).catch((function(o){if(r>0)return n.doRequest(t,e,r-1);throw o}))},t.prototype.interpolateVariable=function(t,e){return"string"==typeof t?e.multi||e.includeAll?"'"+t+"'":t:"number"==typeof t?t:o.a.map(t,(function(e){return"number"==typeof t?t:"'"+e+"'"})).join(",")},t.prototype.getCacheTtl=function(t){if(void 0===t.jsonData.minimalCache)return 3e4;if(t.jsonData.minimalCache<1)throw new Error("Minimal cache must be greater than or equal to 1.");return 1e3*t.jsonData.minimalCache},t}(),m=r(3),g=r(4),y=r.n(g),v=function(){function t(t,e,r,n){this.containerDiv=t,this.defaultTimeField=e,this.getSchema=r,this.config=n,this.splitWithNewLineRegex=/[^\n]+\n?|\n/g,this.newLineRegex=/\r?\n/,this.startsWithKustoPipeRegex=/^\|\s*/g,this.kustoPipeRegexStrict=/^\|\s*$/g}return t.prototype.initMonaco=function(t){var e=this,r=this.config.bootData.user.lightTheme?"grafana-light":"vs-dark";monaco.editor.defineTheme("grafana-light",{base:"vs",inherit:!0,rules:[{token:"comment",foreground:"008000"},{token:"variable.predefined",foreground:"800080"},{token:"function",foreground:"0000FF"},{token:"operator.sql",foreground:"FF4500"},{token:"string",foreground:"B22222"},{token:"operator.scss",foreground:"0000FF"},{token:"variable",foreground:"C71585"},{token:"variable.parameter",foreground:"9932CC"},{token:"",foreground:"000000"},{token:"type",foreground:"0000FF"},{token:"tag",foreground:"0000FF"},{token:"annotation",foreground:"2B91AF"},{token:"keyword",foreground:"0000FF"},{token:"number",foreground:"191970"},{token:"annotation",foreground:"9400D3"},{token:"invalid",background:"cd3131"}],colors:{"textCodeBlock.background":"#FFFFFF"}}),monaco.languages.kusto.kustoDefaults.setLanguageSettings({includeControlCommands:!0,newlineAfterPipe:!0,useIntellisenseV2:!1}),this.codeEditor=monaco.editor.create(this.containerDiv,{value:t.content||"Write your query here",language:"kusto",selectionHighlight:!1,theme:r,folding:!0,lineNumbers:"off",lineHeight:16,suggestFontSize:13,dragAndDrop:!1,occurrencesHighlight:!1,minimap:{enabled:!1},renderIndentGuides:!1,wordWrap:"on"}),this.codeEditor.layout(),1===monaco.editor.getModels().length&&(this.completionItemProvider=monaco.languages.registerCompletionItemProvider("kusto",{triggerCharacters:["."," "],provideCompletionItems:this.getCompletionItems.bind(this)}),this.signatureHelpProvider=monaco.languages.registerSignatureHelpProvider("kusto",{signatureHelpTriggerCharacters:["(",")"],provideSignatureHelp:this.getSignatureHelp.bind(this)})),this.codeEditor.createContextKey("readyToExecute",!0),this.codeEditor.onDidChangeCursorSelection((function(t){e.onDidChangeCursorSelection(t)})),this.getSchema().then((function(t){t&&monaco.languages.kusto.getKustoWorker().then((function(r){var n,o=null===(n=e.codeEditor)||void 0===n?void 0:n.getModel();o&&r(o.uri).then((function(r){var n,o=Object.keys(t.Databases).length>0?Object.keys(t.Databases)[0]:"";r.setSchemaFromShowSchema(t,"https://help.kusto.windows.net",o),null===(n=e.codeEditor)||void 0===n||n.layout()}))}))}))},t.prototype.setOnDidChangeModelContent=function(t){var e;null===(e=this.codeEditor)||void 0===e||e.onDidChangeModelContent(t)},t.prototype.disposeMonaco=function(){if(this.completionItemProvider)try{this.completionItemProvider.dispose()}catch(t){console.error("Failed to dispose the completion item provider.",t)}if(this.signatureHelpProvider)try{this.signatureHelpProvider.dispose()}catch(t){console.error("Failed to dispose the signature help provider.",t)}if(this.codeEditor)try{this.codeEditor.dispose()}catch(t){console.error("Failed to dispose the editor component.",t)}},t.prototype.addCommand=function(t,e){var r;null===(r=this.codeEditor)||void 0===r||r.addCommand(t,e,"readyToExecute")},t.prototype.getValue=function(){var t;return null===(t=this.codeEditor)||void 0===t?void 0:t.getValue()},t.prototype.toSuggestionController=function(t){return t},t.prototype.setEditorContent=function(t){var e;null===(e=this.codeEditor)||void 0===e||e.setValue(t)},t.prototype.getCompletionItems=function(t,e){var r="##### Macro that uses the selected timerange in Grafana to filter the query.\n\n- `$__timeFilter()` -> Uses the "+this.defaultTimeField+" column\n\n- `$__timeFilter(datetimeColumn)` ->  Uses the specified datetime column to build the query.",n=t.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:e.lineNumber,endColumn:e.column});return o.a.includes(n,"|")?o.a.includes(n.toLowerCase(),"where")?o.a.includes(t.getLineContent(e.lineNumber).toLowerCase(),"where")?[{label:"$__timeFilter(timeColumn)",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__timeFilter(${0:"+this.defaultTimeField+"})"},documentation:{value:r}},{label:"$__from",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__from"},documentation:{value:"Built-in variable that returns the from value of the selected timerange in Grafana.\n\nExample: `where "+this.defaultTimeField+" > $__from` "}},{label:"$__to",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__to"},documentation:{value:"Built-in variable that returns the to value of the selected timerange in Grafana.\n\nExample: `where "+this.defaultTimeField+" < $__to` "}},{label:"$__interval",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__interval"},documentation:{value:"##### Built-in variable that returns an automatic time grain suitable for the current timerange.\n\nUsed with the bin() function - `bin("+this.defaultTimeField+", $__interval)` \n\n[Grafana docs](http://docs.grafana.org/reference/templating/#the-interval-variable)"}}]:[]:[{label:"where $__timeFilter(timeColumn)",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"where \\$__timeFilter(${0:"+this.defaultTimeField+"})"},documentation:{value:r}}]:[]},t.prototype.getSignatureHelp=function(t,e,r){return"$__timeFilter("!==t.getValueInRange({startLineNumber:e.lineNumber,startColumn:e.column-14,endLineNumber:e.lineNumber,endColumn:e.column})?{}:{activeParameter:0,activeSignature:0,signatures:[{label:"$__timeFilter(timeColumn)",parameters:[{label:"timeColumn",documentation:"Default is "+this.defaultTimeField+" column. Datetime column to filter data using the selected date range. "}]}]}},t.prototype.onDidChangeCursorSelection=function(t){"modelChange"===t.source&&t.reason===monaco.editor.CursorChangeReason.RecoverFromMarkers&&(" "===this.getCharAt(t.selection.positionLineNumber,t.selection.positionColumn-1)&&this.triggerSuggestions())},t.prototype.triggerSuggestions=function(){var t,e=null===(t=this.codeEditor)||void 0===t?void 0:t.getContribution("editor.contrib.suggestController");if(e){var r=this.toSuggestionController(e);r._model.cancel(),setTimeout((function(){r._model.trigger(!0)}),10)}},t.prototype.getCharAt=function(t,e){var r,n=null===(r=this.codeEditor)||void 0===r?void 0:r.getModel();if(!n)return"";if(0===n.getLineCount()||n.getLineCount()<t)return"";var o=n.getLineContent(t);return o.length<e||e<1?"":o[e-1]},t}(),b=r(1),w=r.n(b);function C(t,e,n){var o=e.find("#content")[0];function a(t,e){var r=new v(t,e.defaultTimeField,e.getSchema,w.a);r.initMonaco(e),r.addCommand(monaco.KeyMod.Shift|monaco.KeyCode.Enter,(function(){var t=r.getValue();e.content=t,e.onChange()})),e.$watch("content",(function(t,n){var o=r.getValue();t!==o&&t!==n&&e.$$postDigest((function(){r.setEditorContent(t)}))})),r.setOnDidChangeModelContent((function(){e.$apply((function(){var t=r.getValue();e.content=t}))})),e.$on("$destroy",(function(){r.disposeMonaco()}))}window.hasOwnProperty("monaco")?setTimeout((function(){a(o,t)}),1):window.monaco=r.e(0).then(r.t.bind(null,7,7)).then((function(){setTimeout((function(){a(o,t)}),1)})),o.onblur=function(){t.onChange()},o.onkeydown=function(t){if("Escape"===t.key)return t.stopPropagation(),!0}}y.a.module("grafana.controllers").directive("kustoMonacoEditor",(function(){return{restrict:"E",template:'<div id="content" tabindex="0" style="width: 100%; height: 150px"></div>',scope:{content:"=",onChange:"&",getSchema:"&",defaultTimeField:"@",pluginBaseUrl:"@"},link:C}}));var x=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.defaults={query:["//change this to create your own time series query","","<table name>","| where $__timeFilter(Timestamp)","// | summarize count() by <group by column>, bin(Timestamp, $__interval)","// | order by Timestamp asc"].join("\n"),resultFormat:"time_series",database:""},o.a.defaultsDeep(n.target,n.defaults),n.panelCtrl.events.on("data-received",n.onDataReceived.bind(n),e),n.panelCtrl.events.on("data-error",n.onDataError.bind(n),e),n.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"},{text:"ADX Time series",value:"time_series_adx_series"}],n.showHelp=!0,n.showLastQuery=!0,n.lastQuery="",n.timeNotASC=!1,n.databases=[],n.getDatabases(),n}return e.$inject=["$scope","$injector"],function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.onDataReceived=function(t){this.lastQueryError=void 0,this.lastQuery="",this.timeNotASC=!1;var e=o.a.find(t,{refId:this.target.refId});e&&e.meta&&(this.lastQuery=e.meta.RawQuery,this.timeNotASC=e.meta.TimeNotASC)},e.prototype.onDataError=function(t){this.handleQueryCtrlError(t)},e.prototype.handleQueryCtrlError=function(t){t.query&&t.query.refId&&t.query.refId!==this.target.refId||(t.data&&t.data.results&&t.data.results&&t.data.results[this.target.refId]&&t.data.results[this.target.refId].meta&&""!==t.data.results[this.target.refId].meta.KustoError?this.lastQueryError=t.data.results[this.target.refId].meta.KustoError:t.error&&t.error.data&&t.error.data.error&&t.error.data.error.innererror?t.error.data.error.innererror.innererror?this.lastQueryError=t.error.data.error.innererror.innererror.message:this.lastQueryError=t.error.data.error.innererror["@message"]:t.error&&t.error.data&&t.error.data.error?this.lastQueryError=t.error.data.error.message:t.error&&t.error.data?this.lastQueryError=t.error.data.message:t.data&&t.data.error?this.lastQueryError=t.data.error.message:t.data&&t.data.message?this.lastQueryError=t.data.message:this.lastQueryError=t)},e.prototype.getDatabases=function(){var t=this;return this.datasource.getDatabases().then((function(e){t.databases=e,e.length>0&&!t.target.database&&(t.target.database=t.datasource.defaultOrFirstDatabase||e[0].value)}))},e.prototype.getSchema=function(){var t=this;return this.getDatabases().then((function(){return t.datasource.getSchema(t.target.database)}))},e.templateUrl="partials/query.editor.html",e}(m.QueryCtrl),S=function(){function t(){this.showHelp=!1,this.defaultQuery='<your table>\n| where $__timeFilter() \n| project TimeGenerated, Text=YourTitleColumn, Tags="tag1,tag2"',this.annotation.rawQuery=this.annotation.rawQuery||this.defaultQuery,this.databases=this.getDatabases()}return t.prototype.getDatabases=function(){var t=this;return this.databases&&this.databases.length>0?this.databases:this.datasource.getDatabases().then((function(e){return t.databases=e,e.length>0&&!t.annotation.database&&(t.annotation.database=e[0].value),t.databases})).catch((function(){}))},t.templateUrl="partials/annotations.editor.html",t}(),T=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/,k=function(){function t(t){this.major=0,this.minor=0,this.patch=0,this.meta="";var e=T.exec(t);e&&(this.major=Number(e[1]),this.minor=Number(e[2]||0),this.patch=Number(e[3]||0),this.meta=e[4])}return t.prototype.isGtOrEq=function(e){for(var r=new t(e),n=0;n<this.comparable.length;++n){if(this.comparable[n]>r.comparable[n])return!0;if(this.comparable[n]<r.comparable[n])return!1}return!0},t.prototype.isValid=function(){return o.a.isNumber(this.major)},Object.defineProperty(t.prototype,"comparable",{get:function(){return[this.major,this.minor,this.patch]},enumerable:!0,configurable:!0}),t}();var _=function(){function t(t,e,r){var n=this;this.hasRequiredGrafanaVersion=this.hasMinVersion(),this.suggestUrl="https://yourcluster.kusto.windows.net",t.getSuggestUrls=function(){return[n.suggestUrl]},this.databases=[],this.current.id&&(this.current.url="api/datasources/proxy/"+this.current.id,this.kustoDbDatasource=new p(this.current,e,r,null),this.getDatabases())}return t.$inject=["$scope","backendSrv","$q"],t.prototype.getDatabases=function(){var t=this;return this.kustoDbDatasource.getDatabases().then((function(e){t.databases=e,t.databases.length>0&&(t.current.jsonData.defaultDatabase=t.current.jsonData.defaultDatabase||t.databases[0].value)}))},t.prototype.hasMinVersion=function(){return t=w.a.buildInfo.latestVersion,e="5.3",new k(t).isGtOrEq(e)||"5.3.0-beta1"===w.a.buildInfo.version||"5.3.0-pre1"===w.a.buildInfo.version;var t,e},t.prototype.showMinVersionWarning=function(){return!this.hasRequiredGrafanaVersion},t.templateUrl="partials/config.html",t}();r.d(e,"Datasource",(function(){return p})),r.d(e,"QueryCtrl",(function(){return x})),r.d(e,"ConfigCtrl",(function(){return _})),r.d(e,"AnnotationsQueryCtrl",(function(){return S}))}])}));